import{k as b,c as a,o as r,a as l,g as c,t as m,F as w,r as v,n as u,b as k,l as E,w as g,v as p,m as f,d as O,p as S,h as F,i as C}from"./vendor.js";import{_ as B,V as y,i as x}from"./custom-fields.js";const I={data:function(){return{item:{},block:{},model:{},onEdit:!1,template_i18n,options:{},tmp_block:{},currentTab:""}},props:{currentModel:{},currentBlockSetting:{},id:"",onSaving:!1},computed:{schema(){const e=this;let t=this.currentBlockSetting.settings??{};return this.currentTab&&(t=Object.fromEntries(Object.entries(t).filter(([s,i])=>i.tab===this.currentTab))),Object.values(t).forEach(s=>{if(typeof s.conditions>"u")return!0;s.visible=function(){var i=!0;return _.forEach(s.conditions,function(d,o){e.model[o]!=d&&!d.includes(e.model[o])&&(i=!1)}),i}}),t},tabs(){return this.currentBlockSetting.setting_tabs||{}},tabKeys(){const e=this.tabs;return Object.keys(this.tabs).sort(t=>(e[t]?.order||0)-(e[t]?.order||0))}},watch:{currentModel(e){this.model=Object.assign({},e??{})},tabKeys(e){this.currentTab=e[0]}},components:{"vue-form-generator":y},methods:{saveModal(){this.$emit("save",Object.assign({},this.model))},hideModal(){this.$emit("cancel")},setTab(e){this.currentTab=e}},mounted(){this.model=Object.assign({},this.currentModel??{}),this.$nextTick(()=>{!this.currentTab&&this.tabKeys.length&&(this.currentTab=this.tabKeys[0])})}},j={class:"d-flex flex-column h-100"},L={class:"text-center flex-shrink-0"},M={class:"modal-title font-weight-medium text-center px-3 py-1 border-bottom-1 border-bottom-solid border-bottom-gray"},N={key:0,class:"form-tabs d-flex align-items-center justify-content-between"},A={class:"flex-grow-1 overflow-auto p-3"},K={class:"modal-footer flex-shrink-0 p-2"},V={class:"fa fa-spin fa-spinner"};function J(e,t,s,i,d,o){const h=b("vue-form-generator");return r(),a("div",j,[l("div",L,[l("h5",M,m(s.currentBlockSetting.name),1),o.tabKeys.length?(r(),a("div",N,[(r(!0),a(w,null,v(o.tabKeys,n=>(r(),a("div",{key:n,class:u(["tab-item py-2 px-1 flex-grow-1",{active:e.currentTab===n}])},[o.tabs[n].icon?(r(),a("i",{key:0,class:u(o.tabs[n].icon)},null,2)):c("",!0),k(" "+m(o.tabs[n].label),1)],2))),128))])):c("",!0)]),l("div",A,[E(h,{schema:{fields:o.schema},model:e.model,options:e.options},null,8,["schema","model","options"])]),l("div",K,[l("button",{type:"button",class:"btn btn-secondary",onClick:t[0]||(t[0]=(...n)=>o.hideModal&&o.hideModal(...n))},m(e.template_i18n.cancel),1),l("button",{type:"button",class:"btn btn-primary",onClick:t[1]||(t[1]=(...n)=>o.saveModal&&o.saveModal(...n))},[k(m(e.template_i18n.save_block)+" ",1),g(l("i",V,null,512),[[p,s.onSaving]])])])])}const z=B(I,[["render",J]]),D={name:"layer-item",data:function(){return{i18n:template_i18n,showChildren:!1}},props:{items:{},id:"",selectedBlockId:"",parent:""},computed:{block(){return this.items[this.id]??{}}},methods:{selectBlock(){window.LiveEditorEventBus.emit("select-block",this.id)},emmitSelect(e){window.LiveEditorEventBus.emit("select-block",e)},sortEnd(e){console.log(e)},deleteItem(){confirm(this.i18n.delete_confirm)&&window.LiveEditorEventBus.emit("delete-item",{id:this.id})},showAddBlock(){this.block.type==="row"?window.LiveEditorEventBus.emit("add-block",{to:this.id,children:[{id:"column",model:{size:6},parent:this.id}]}):window.LiveEditorEventBus.emit("show-add-block",{id:this.id})}}},P={key:0,"stroke-linecap":"round","stroke-linejoin":"round",d:"m8.25 4.5 7.5 7.5-7.5 7.5"},R={key:1,"stroke-linecap":"round","stroke-linejoin":"round",d:"m19.5 8.25-7.5 7.5-7.5-7.5"},W={key:0,class:"b-ml-2"},G={class:"dropdown",title:"Options"},Q={class:"dropdown-menu","aria-labelledby":"dropdownMenuButton"},q={class:"layer-children b-pl-6"},H={key:0},U={key:1};function X(e,t,s,i,d,o){const h=b("layer-item");return r(),a("div",{class:u(["layer-item",{selected:s.selectedBlockId===s.id}])},[l("div",{class:u(["layer-name d-flex justify-content-between align-items-center b-py-0",{"b-pl-2":s.parent}])},[o.block.nodes||o.block.is_container?(r(),a("svg",{key:0,onClick:t[0]||(t[0]=n=>e.showChildren=!e.showChildren),class:"b-cursor-pointer b-mr-2 b-w-4 b-h-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[e.showChildren?c("",!0):(r(),a("path",P)),e.showChildren?(r(),a("path",R)):c("",!0)])):c("",!0),l("div",{class:"drag-handler flex-grow-1 b-truncate b-text-sm",onClick:t[1]||(t[1]=f((...n)=>o.selectBlock&&o.selectBlock(...n),["prevent"]))},[k(m(o.block.name)+" ",1),o.block.type==="column"?(r(),a("strong",W,m(o.block.model.size)+"/12",1)):c("",!0)]),l("div",G,[t[4]||(t[4]=l("span",{"data-toggle":"dropdown",class:"py-1 px-2"},[l("i",{class:"fa fa-cog"})],-1)),l("div",Q,[l("a",{class:"dropdown-item text-danger",onClick:t[2]||(t[2]=(...n)=>o.deleteItem&&o.deleteItem(...n)),href:"#"},"Delete")])])],2),g(l("div",q,[o.block.nodes?(r(!0),a(w,{key:0},v(o.block.nodes,(n,T)=>(r(),O(h,{onSelectBlock:o.emmitSelect,"selected-block-id":s.selectedBlockId,items:s.items,key:T,id:n,parent:s.id},null,8,["onSelectBlock","selected-block-id","items","id","parent"]))),128)):c("",!0),o.block.is_container?(r(),a("div",{key:1,onClick:t[3]||(t[3]=f((...n)=>o.showAddBlock&&o.showAddBlock(...n),["prevent"])),class:"b-px-2 b-py-1 b-cursor-pointer b-flex-inline b-items-center"},[t[5]||(t[5]=l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"b-w-4 b-h-4"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 4.5v15m7.5-7.5h-15"})],-1)),o.block.type=="row"?(r(),a("span",H,m(e.i18n.add_column),1)):(r(),a("span",U,m(e.i18n.add_children),1))])):c("",!0)],512),[[p,e.showChildren]])],2)}const Y=B(D,[["render",X]]);window.LiveEditorEventBus=S();window.LiveEditor=F({data:()=>({items:current_template_items,blocks:[],message:{content:"",type:!1},onSaving:!1,s:"",selectedBlockId:"",frame:null,showAddBlock:!1,lastSaved:current_last_saved,addBlockForId:null,model:{},options:{},schema:[{id:"title",type:"input",inputType:"text",label:"Title",adminLabel:!0,model:"title"}]}),mounted(){this.reloadBlocks(),this.$nextTick(()=>{window.addEventListener("message",e=>{try{const t=JSON.parse(e.data);if(t?.action)switch(t?.action){case"select-item":this.selectItemFromFrame(t?.data.id);break;case"show-add-layer":this.showAddBlock=!0;break}}catch(t){console.log(t)}}),this.sendToFrame({action:"set_items",data:this.items})}),window.LiveEditorEventBus.on("delete-item",e=>{this.deleteItem(e)}),window.LiveEditorEventBus.on("show-add-block",e=>{this.showAddBlock=!0,this.addBlockForId=e?.id}),window.LiveEditorEventBus.on("add-block",e=>{e?.children?.length&&e.to&&e?.children?.forEach(t=>{this.addBlockTo(e.to,{...t})})}),window.LiveEditorEventBus.on("select-block",e=>{this.selectBlock(e)})},computed:{filteredBlocks:function(){const e={};return this.s?(Object.entries(this.blocks).forEach(([t,s])=>{e[t]=Object.assign({},s),e[t].items=s.items.filter(i=>i.name.toLowerCase().includes(this.s.toLowerCase()))||[]}),e):this.blocks},blocksMapById(){let e={};return Object.entries(this.blocks).forEach(([,t])=>{t.items.forEach(s=>{e[s.id]=s})}),e},currentModel(){return this.items[this.selectedBlockId].model??{}},currentBlockSetting(){return this.blocksMapById[this.items[this.selectedBlockId].type]??{}}},watch:{currentModel(e){console.log(e)}},methods:{sendToFrame(e){const t=document.getElementById("frame-preview");t&&t.contentWindow&&t.contentWindow.postMessage(JSON.stringify(e),"*")},reloadBlocks(){var e=this;jQuery.ajax({url:bookingCore.admin_url+"/module/template/getBlocks",dataType:"json",type:"get",success:function(t){t.status&&(e.blocks=t.data)},error:function(t){console.log(t)}})},selectBlock(e){this.selectedBlockId=e,this.sendToFrame({action:"select-item",data:e})},selectItemFromFrame(e){this.selectedBlockId=e},saveTemplate(){var e=this;this.onSaving=!0,$.ajax({url:bookingCore.admin_url+"/module/template/store",dataType:"json",type:"post",data:{id:template_id,content:JSON.stringify(this.items),title:this.title,lang:current_menu_lang},success:function(t){e.onSaving=!1,e.lastSaved=t.lastSaved,t.message&&(e.message.content=t.message,e.message.type=t.status),t.url&&(window.location.href=t.url),window.setTimeout(()=>{e.message.content=""},3e3)},error:function(t){e.onSaving=!1,t.responseJSON.message?(e.message.content=t.responseJSON.message,e.message.type=!1):(e.message.content="Can not save menu",e.message.type=!1)}})},cancelEdit(){this.selectedBlockId=""},saveBlock(e){this.selectedBlockId&&this.items[this.selectedBlockId]&&(this.items[this.selectedBlockId].model=e,this.sendToFrame({action:"save_block",data:{id:this.selectedBlockId,model:e,tree:this.getTreeForNodeId(this.selectedBlockId)}}),this.saveTemplate())},sortEnd(e){this.saveTemplate(),this.sendToFrame({action:"sort-end",data:e.moved})},deleteItem(e){const t=e.id,s=this.items[t];if(typeof s<"u"){this.selectedBlockId="";const i=this.items[s.parent].nodes;typeof i<"u"&&i.indexOf(t)!==-1&&this.items[s.parent].nodes.splice(i.indexOf(t),1),delete this.items[t],this.sendToFrame({action:"delete-item",data:e}),this.saveTemplate()}},addBlock(e){this.addBlockTo(this.addBlockForId||"ROOT",e)},addBlockTo(e,t,s){const i=this.makeid(20),d=this.blocksMapById[t.id];if(!d){console.log("No findBlock",d,t);return}const o=this.getBlockParams({...d});if(o.parent=e,!this.items[e]){console.log("No parentId"+e,d,t);return}this.items[e].nodes=this.items[e].nodes||[],this.items[e].nodes.push(i),this.items[i]=o,e!=="ROOT"?this.sendToFrame({action:"save_block",data:{id:e,model:{},tree:this.getTreeForNodeId(this.parentId)}}):this.sendToFrame({action:"add_block",data:{id:i,model:t.model,blockType:t.id}}),t.preset_children?.length&&t.preset_children.forEach(h=>{const n={...h};this.addBlockTo(i,n,{noActiveBlock:!1})}),this.$nextTick(()=>{!s?.noActiveBlock&&e!=="ROOT"&&this.selectBlock(i),this.showAddBlock=!1})},getBlockParams(e){let t={type:e.id,name:e.name,model:e.model,component:e.component,open:!0};return e.is_container&&(t.is_container=!0,t.children=[]),t},makeid(e){let t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=s.length;let d=0;for(;d<e;)t+=s.charAt(Math.floor(Math.random()*i)),d+=1;return t.toLowerCase()},getTreeForNodeId(e,t=0){let s={};return t===0&&this.items[e]&&(s[e]=this.items[e]),this.items[e]?.nodes&&this.items[e].nodes.forEach(i=>{this.items[i]&&(s[i]=this.items[i]),s={...s,...this.getTreeForNodeId(i,t+1)}}),s}},components:{BlockForm:z,LayerItem:Y,draggable:C,VueFormGenerator:y}});window.LiveEditor.mount("#live-editor");x(window.LiveEditor);
//# sourceMappingURL=templateLive.js.map
